# MVU系统概述

## 系统定义

MVU（Magical Variable Update）是一个用于实现角色和世界动态性的变量管理框架。该系统通过变量追踪和条件触发,使角色和世界能够根据故事进展展现不同的行为模式和状态。

---

## 核心组件

MVU 系统由以下5个核心模块组成：

### 模块1：变量初始化 `[InitVar]`

**功能**：定义系统中所有动态变量的初始值

**格式**：JSON5格式，键值对结构

**特点**：
- 仅包含变量名和初始值
- 不包含更新规则（更新规则在模块2）
- 变量值存储在 `stat_data` 宏中
- 世界书条目名称需包含 `[InitVar]` 标记

**版本**：
- **稳定版**（文件1.1）：纯数据初始化，数组与对象结构默认锁定
- **Beta版**（文件1.2）：支持 `$meta` 和 `$__META_EXTENSIBLE__$` 元信息，启用结构变更校验

---

### 模块2：变量更新规则

**功能**：独立定义每个变量的更新逻辑和约束条件

**格式**：YAML格式，结构化描述

**内容**：
- `type`：变量类型
- `range`：取值范围和约束
- `check`：触发更新的条件

**优势**：与初始化分离，便于维护和修改

---

### 模块3：变量处理指令集

**功能**：向 AI 展示变量状态并提供标准化的更新指令格式

**核心内容**：
- 显示当前所有变量的状态值
- 引用变量更新规则，指导 AI 判断更新时机
- 规定标准的输出格式（分析过程 + 更新命令）

**版本**：
- **稳定版**（文件3.1）：使用 `_.set` 基本更新命令
- **Beta版**（文件3.2）：新增 `_.add`、`_.insert`、`_.remove` 等增强命令，配合模式校验使用

---

### 模块4：动态内容展示

**功能**：根据变量值动态调整内容

**实现方式**：使用 EJS 条件判断，基于变量状态选择不同的内容

**应用场景**：
- **4.1 分阶段角色设定**：好感度变化、故事进展等触发的角色行为差异
- **4.2 动态世界内容**：场景描述、事件触发、内心独白等

---

### 模块5：HTML状态展示

**功能**：为用户提供直观的变量状态可视化界面

**特点**：
- 实时显示重要变量的当前值
- 进度条、文本等多种展示方式
- 增强用户沉浸感

---

## 工作流程

MVU 系统的完整工作流程包含5个阶段：

1. **变量定义与初始化** - 确定需要追踪的动态变量并设置初始值
2. **更新规则设计** - 为每个变量定义类型、范围和更新条件
3. **指令集配置** - 建立 AI 感知变量状态和输出更新指令的机制
4. **动态内容设定** - 基于变量值配置动态角色行为或世界内容
5. **状态可视化** - 为用户提供直观的系统状态展示

---

## 系统优势

- **模块化设计**：各组件职责清晰，便于独立维护和扩展
- **关注点分离**：初始化、更新规则、展示逻辑相互独立
- **高度可配置**：支持复杂的变量依赖关系和条件逻辑
- **用户友好**：提供直观的状态反馈和可视化界面

---

## Beta版特性：数据结构安全

Beta版引入"模式校验保护机制"，防止 LLM 误用 `insert`/`remove` 导致结构破坏。

### 对象元信息：`$meta`

在 `[InitVar]` 的JSON数据中，为对象添加 `$meta` 键声明结构规则：

**属性说明**：

- `extensible`（默认 `false`）
  - `false`：对象结构锁定，禁止添加/删除键
  - `true`：对象结构开放，允许 `_.insert` 添加键、`_.remove` 删除键

- `required`: `string[]`
  - 列表中的键为必需项，禁止被 `_.remove` 删除

- `recursiveExtensible`: `boolean`（默认 `false`）
  - `true` 时，本对象的所有子孙对象均可扩展，直至遇到某层显式设置 `extensible: false`

- `template`: `object | array`
  - 使用 `_.insert` 新增结构时，与该模板进行深度合并，自动补齐必要的子结构

### 数组扩展标记：`$__META_EXTENSIBLE__$`

- 默认所有数组结构均锁定
- 在数组任意位置放置特殊字符串 `$__META_EXTENSIBLE__$`，则该数组结构视为可扩展
- 允许 `_.insert`/`_.remove` 对其进行增删项
- 初始化完成后该字符串会自动移除

### 示例（节选）

```json5
{
  "人物": {
    "$meta": {
      "extensible": false,
      "required": ["姓名", "属性"],
      "template": {
        "属性": {"力量": 0, "敏捷": 0, "智力": 0}
      }
    },
    "姓名": "白夭夭",
    "属性": {
      "$meta": {
        "extensible": true,
        "required": ["力量", "敏捷", "智力"]
      },
      "力量": 3,
      "敏捷": 4,
      "智力": 5
    }
  },
  "记忆": [
    "$__META_EXTENSIBLE__$",
    "雨中初遇"
  ]
}
```

### 生效方式

- 在世界书初始化及每次结构变动后，系统从当前 `stat_data` 生成"模式（schema）"
- LLM 执行 `_.insert`/`_.remove` 等结构性变更时，对照该模式进行校验
- 拦截未授权的结构变更
- 初始化完成后，所有元信息会被移除，不会出现在后续的 `stat_data` 中

### 使用建议

- 若项目使用 MVU Beta 运行时，可在 `[InitVar]` 中使用上述元信息以获得结构保护
- 若使用稳定版运行时，请勿加入这些元信息，以免被当作普通数据保存
- 优先为根对象与关键子对象定义 `$meta`
- 仅对确需动态增删的数组添加 `$__META_EXTENSIBLE__$`
- 其余保持锁定有助于稳定性

---

## 重要提示

**当前阶段**：此文档仅用于理解 MVU 系统概念，无需执行具体操作。

**后续使用**：各功能模块将基于此框架进行构建与扩展，理解此核心框架是高效使用的基础。
