# 模块4.1：分阶段角色设定生成指令（YAML与EJS）

## 模块定义

本模块基于前面模块定义的变量和更新规则，生成一份完整的、用于动态展示角色不同阶段性格的世界书条目。此条目将使用 YAML 格式进行结构化描述，并内嵌严格的一层 `if/else if` EJS 逻辑，根据模块1中初始化的 MVU 变量值来动态呈现相应的内容。

---

## 内容设计原则

在构思每个阶段的内容时，遵循以下核心原则：

- **阶段独立性**：每个阶段的描述必须是完整且自洽的，AI 仅凭当前阶段的信息就能进行表演
- **独特性，避免升级**：新阶段的"行为指导"应引入该阶段特有的行为，而不是对前一阶段行为的简单增强或升级
- **内容丰富性**：行为指导应覆盖角色与 `<user>` 的互动、对其他 NPC 的态度，以及角色的独立行为
- **角色底线**：所有阶段的行为都不能违背角色的核心设定与根本原则

---

## 技术实现要求

### 1. 选定驱动变量与划分阶段

- 从模块1中选择一个核心 MVU 变量作为此设定的驱动变量（例如 `stat_data.角色名.好感度[0]`）
- 结合模块2中该变量的 range 定义，设定清晰的数值范围，将其划分为大约5个阶段（包含一个最终阶段）

### 2. 为每个阶段创作内容

- **阶段命名**：为每个阶段构思一个能反映其核心特点的四字名称
- **行为指导**：为每个普通阶段编写 4-6 条行为指导，为最终阶段编写 6-9 条
- **变化倾向**：为除最终阶段外的每个阶段编写 2-4 条变化倾向，描述角色在数值接近下一阶段时的行为趋势

### 3. 编写 EJS 与 YAML 结构

#### EJS 条件判断规则

- 必须使用严格的一层 `if/else if` 结构
  ```ejs
  <%_ if (getvar('stat_data.角色名.好感度[0]') < 20) { _%>
  ```
- **严禁**在 EJS 块内声明任何局部变量
- **取消最终 `else` 警告**：由于人设加载通常慢于变量加载，为避免恒触发的无意义警告，模板不包含最终 `else` 分支；确保阶段数值范围覆盖所有可能值

#### 结构要求

- 输出格式必须是完整的、包含 EJS 逻辑的 YAML 格式文本块
- 每个阶段的 YAML 文本块必须紧跟在其对应的 `<%_ if (...) { _%>` 标签之后
- 以 `<%_ } _%>` 标签结束

---

## 输出模板与结构

严格参照以下模板，将所有占位符（`${...}`）及 EJS 逻辑中的变量路径和数值替换为实际内容。

```yaml
---
<[角色名的小写英文或拼音]_staged_performance>
角色阶段:
  描述: "${总体概述该角色的阶段系统反映了什么成长或变化历程，每个阶段代表什么意义，需结合角色特点个性化描述}"
  行为指导: "${说明角色应根据当前阶段的行为指导进行表现，这些指导的优先级和作用范围}"
  变化倾向: "${说明当数值接近下一阶段时角色会展现什么样的变化趋势和特征，体现阶段间的过渡}"

${主名}: {{// 将 ${主名} 替换为实际角色名，例如：理 }}
  associated_variable: ${关联变量的简洁名称，例如：好感度} (<%= getvar('stat_data.角色名.关联变量名') %>)
  stage_names_overview: {{// 此处仅为概览，实际显示由EJS控制 }}
    - ${阶段1名称} (${阶段1范围，例如：< 20})
    - ${阶段2名称} (${阶段2范围，例如：20-49})
    - ${阶段3名称} (${阶段3范围，例如：50-79})
    - ${阶段max名称} (${阶段max范围，例如：>= 80})

  <%_ if (getvar('stat_data.角色名.关联变量名') < 20) { _%>
  ${阶段1名称}:
    行为指导:
      - "${阶段1具体行为1}"
      - "${阶段1具体行为2}"
      - "${阶段1具体行为3}"
      - "${阶段1具体行为4}"
    变化倾向:
      - "${阶段1具体变化倾向1}"
      - "${阶段1具体变化倾向2}"
  <%_ } else if (getvar('stat_data.角色名.关联变量名') >= 20 && getvar('stat_data.角色名.关联变量名') < 50) { _%>
  ${阶段2名称}:
    行为指导:
      - "${阶段2新的独特行为1}"
      - "${阶段2新的独特行为2}"
      - "${阶段2新的独特行为3}"
      - "${阶段2新的独特行为4}"
    变化倾向:
      - "${阶段2新的独特变化倾向1}"
      - "${阶段2新的独特变化倾向2}"
  <%_ } else if (getvar('stat_data.角色名.关联变量名') >= 50 && getvar('stat_data.角色名.关联变量名') < 80) { _%>
  ${阶段3名称}:
    行为指导:
      - "${阶段3新的独特行为1}"
      # ... (更多行为)
    变化倾向:
      - "${阶段3新的独特变化倾向1}"
      # ... (更多倾向)
  <%_ } else if (getvar('stat_data.角色名.关联变量名') < 100) { _%>
  ${阶段max名称}:
    行为指导:
      - "${阶段max新的独特行为1}"
      - "${阶段max新的独特行为2}"
      - "${阶段max新的独特行为3}"
      - "${阶段max新的独特行为4}"
      - "${阶段max新的独特行为5}"
      - "${阶段max新的独特行为6}"
    {{// 最终阶段通常不必再有变化倾向}}
  <%_ } _%>
</[角色名的小写英文或拼音]_staged_performance>
```

---

## 输出要求

### 1. 内容替换

将上述模板中的所有 `${占位符}` 以及 EJS 条件中的变量路径和数值范围，替换为精心构思的实际内容：

- `${主名}`：实际角色名（例如：理）
- `${关联变量的简洁名称}`：变量名称（例如：好感度）
- `${阶段N名称}`：四字阶段名称
- `${阶段N具体行为N}`：具体的行为描述
- `${阶段N具体变化倾向N}`：具体的变化倾向描述
- EJS 路径：`stat_data.角色名.关联变量名` 替换为实际路径

### 2. 变量来源

- 驱动变量必须是模块1中已初始化的变量
- 阶段划分应参考模块2中该变量的 range 和 check 定义

### 3. 系统集成

- 生成的角色设定将与模块3的变量处理指令集配合工作
- 当变量值通过模块3的指令更新时，角色表现会自动切换到对应阶段

### 4. 附加说明

在完整输出角色设定后，提供以下说明文字：

#### a. 存放位置

"此 YAML 数据块应放置于世界书的任意条目中，该条目的名称应包含角色名（例如：`[角色名]分阶段设定`），且该条目通常需要启用。条目名称不应包含文件后缀。"

#### b. EJS 语法

"模板使用 EJS 条件判断来动态选择对应阶段内容。`getvar('stat_data.变量路径')` 用于获取当前变量值，确保变量路径与模块1中的定义一致。"

#### c. 调试建议

"若需调试阶段切换逻辑，可在各阶段开头临时添加日志输出，但正式使用时应移除，以避免不必要的输出。"

---

## 生成指令

生成内容后，使用 Write 工具将完整角色阶段设定保存到 `[角色名]分阶段设定.xyaml` 文件中（例如：`理分阶段设定.xyaml`）。

---

## 额外要求

如用户有额外指示（如特定的阶段划分、行为偏好等），优先遵循用户的具体要求。
