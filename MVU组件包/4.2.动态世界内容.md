# 模块4.2：动态世界内容生成指令（灵活版）

## 模块定义

本模块是模块4的补充与延伸，提供了一种更为灵活的方式来生成由变量驱动的动态世界书内容。它不局限于角色设定的结构，允许根据变量状态，自由编写任何形式的文本，如场景描述、事件触发、内心独白等。

---

## 内容设计原则

### 1. 选定驱动变量与划分区间/状态

- 从模块1中确定一个或多个核心 MVU 变量作为条件判断的依据
- 为变量设定清晰的数值范围、特定的文本值或其他状态条件，用于划分不同的触发区间

### 2. 为每个区间/状态创作独特的提示词内容

- **指令性内容**：针对每个条件区间，编写给 LLM 的指令性提示词（事件触发指示、行为优先级说明、剧情推进建议等）
- **重要原则**：LLM 只能看到 EJS 处理后符合条件的内容，看不到其他分支。因此每个分支的内容应该是完整的、自洽的指令，而非单纯的场景描述
- **独特性与逻辑性**：确保每个区间触发的提示词内容都是独特的，并与驱动变量的当前状态逻辑相符

---

## EJS 结构规范

为保证系统的稳定与清晰，严格遵循以下优化的极简 EJS 结构：

### 1. 错误优先处理

脚本的起始处，必须使用一个独立的 `if` 块来检查关键变量是否已定义。这是最优先的检查，能有效避免后续操作因变量不存在而出错。

### 2. 条件逻辑链

在处理完错误情况后，使用 `else if` 链来处理所有有效的条件分支。在这些分支中，无需再重复检查变量是否存在。

### 3. 禁止声明局部变量

在 EJS 块内，每次进行条件判断或获取值时，都应直接调用 `getvar` 函数。

### 4. 取消最终后备 `else`

为避免在加载顺序差异下出现恒触发的默认提示，不再在链末尾添加 `else`。通过完善条件区间来覆盖所有有效状态；必要时仅在调试时临时输出日志。

### 5. 内容输出

在每个条件分支的 `<%_ ... _%>` 标签之后，直接编写该条件下需要输出的、任意格式的独特提示词文本。

**重要**：由于提示词篇幅较短，可能被埋没在大量提示词中，应使用小写英文 XML 标签包裹提示词内容以增强可见性。例如：`<plot_guide>`、`<event_trigger>`、`<priority_instruction>` 等。

---

## 输出模板

严格参考以下模板，将所有占位符及 EJS 逻辑中的变量路径、条件和输出内容替换为实际内容。

```yaml
---
<%_ if (getvar('stat_data.角色名.好感度') === undefined) { _%>
{{// 错误：关联变量 "stat_data.角色名.好感度" 未定义，无法生成条件内容。}}
<%_ } else if (getvar('stat_data.角色名.好感度') < 20) { _%>
{{// 当好感度小于 20 时：}}
<plot_guide>
当前角色对 <user> 的好感度较低,处于陌生或警戒状态。应保持距离感,避免过度亲密的互动。如有接触,应表现出礼貌但冷淡的态度。
</plot_guide>
<%_ } else if (getvar('stat_data.角色名.好感度') >= 20 && getvar('stat_data.角色名.好感度') < 50) { _%>
{{// 当好感度在 20-49 之间时：}}
<plot_guide>
当前角色对 <user> 的好感度处于初步认识阶段。可以进行日常交流,但仍保持一定界限。适合安排一些轻松的互动事件,逐步加深了解。
</plot_guide>
<%_ } else if (getvar('stat_data.角色名.好感度') >= 50 && getvar('stat_data.角色名.好感度') < 80) { _%>
{{// 当好感度在 50-79 之间时：}}
<plot_guide>
当前角色对 <user> 的好感度较高,已建立良好关系。可以安排更深入的互动,包括私密对话、共同活动等。角色会主动关心 <user> 的状况。
</plot_guide>
<%_ } else if (getvar('stat_data.角色名.好感度') >= 80) { _%>
{{// 当好感度达到 80 及以上时：}}
<plot_guide>
当前角色对 <user> 的好感度非常高,处于深厚情感阶段。应该在合适的时间和场景安排表白事件或关键剧情推进,优先级高。角色会表现出明显的情感倾向。
</plot_guide>
<%_ } _%>
```

---

## 输出要求

### 1. 内容替换

将上述模板中的所有占位符替换为实际内容：

- `stat_data.角色名.好感度`：实际变量路径（例如：`stat_data.理.情绪值`）
- 条件数值：根据模块2中定义的范围调整
- 输出文本：编写给 LLM 的指令性提示词，说明当前状态下应该如何行动、触发什么事件、优先级如何等

**内容要求**：
- 每个分支的内容应该是对 LLM 的明确指示
- 包含行为指导、事件触发条件、优先级说明等
- 避免单纯的场景描述，应该是可执行的指令
- 使用小写英文 XML 标签包裹提示词内容（如 `<plot_guide>`、`<event_trigger>`、`<priority_instruction>` 等），增强在大量提示词中的可见性

### 2. 变量来源

- 驱动变量必须是模块1中已初始化的变量
- 条件区间的划分应参考模块2中为该变量定义的规则

### 3. 功能定位

- 此模块是对模块 4.1（分阶段角色设定）的补充
- 适用于创建更多样化、非角色中心的动态世界内容和事件
- 主要用于事件触发、剧情推进指示、行为优先级控制等场景
- 输出内容为指令性提示词，直接指导 LLM 的行为，而非描述性文本

### 4. 附加说明

在完整输出动态内容后，提供以下说明文字：

#### a. 存放位置

"此 EJS 驱动内容应放置于世界书的任意条目中，该条目的名称应反映其功能（例如：`[动态场景]`、`[事件触发]`），且该条目通常需要启用。条目名称不应包含文件后缀。"

#### b. 内容特点

"与模块 4.1 的结构化角色设定不同，本模块输出的是指令性提示词。LLM 只能看到符合当前条件的分支内容，因此每个分支应包含完整的行为指导、事件触发说明或优先级指示，而非单纯的场景描述。"

#### c. 调试建议

"若需调试条件触发逻辑，可在各分支开头临时添加日志输出，但正式使用时应移除，以避免不必要的输出。"

---

## 生成指令

生成内容后，使用 Write 工具将完整的 EJS 驱动内容保存到 `动态世界内容.xyaml` 文件中。

---

## 额外要求

如用户有额外指示（如特定的触发条件、输出格式等），优先遵循用户的具体要求。
